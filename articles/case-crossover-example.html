<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="appc">
<title>Case-Crossover Example â€¢ appc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Case-Crossover Example">
<meta property="og:description" content="appc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">appc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/case-crossover-example.html">Case-Crossover Example</a>
    <a class="dropdown-item" href="../articles/cv-model-performance.html">CV Model Performance</a>
    <a class="dropdown-item" href="../articles/timeline-example.html">Timeline Example</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/geomarker-io/appc/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Case-Crossover Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/geomarker-io/appc/blob/HEAD/vignettes/case-crossover-example.Rmd" class="external-link"><code>vignettes/case-crossover-example.Rmd</code></a></small>
      <div class="d-none name"><code>case-crossover-example.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/geomarker-io/appc" class="external-link">appc</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>This example details how to use the appc package to add air pollution
exposure estimates for exact locations and dates defined by geocoded
coordinates and a case date. For this example workflow, we will simulate
20 random locations in Wayne County, Michigan and case dates in 2022,
but in actuality this can be any set of geocoded <code>lat</code> and
<code>lon</code> columns with corresponding dates.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tigris</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tigris/man/counties.html" class="external-link">counties</a></span><span class="op">(</span><span class="st">"MI"</span>, year <span class="op">=</span> <span class="fl">2021</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">GEOID</span> <span class="op">==</span> <span class="fl">26163</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="va">Y</span>, lon <span class="op">=</span> <span class="va">X</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>case_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-12-31"</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span></span>
<span><span class="va">d</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 Ã— 4</span></span></span>
<span><span class="co">#&gt;       id   lon   lat case_date </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 -<span style="color: #BB0000;">83.4</span>  42.3 2022-03-04</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 -<span style="color: #BB0000;">83.2</span>  42.3 2022-12-08</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 -<span style="color: #BB0000;">83.1</span>  42.4 2022-11-16</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 -<span style="color: #BB0000;">83.5</span>  42.4 2022-11-21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 -<span style="color: #BB0000;">83.3</span>  42.3 2022-03-30</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 -<span style="color: #BB0000;">83.4</span>  42.2 2022-09-25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 -<span style="color: #BB0000;">83.5</span>  42.3 2022-11-10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 -<span style="color: #BB0000;">83.2</span>  42.2 2022-05-21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 -<span style="color: #BB0000;">83.5</span>  42.2 2022-02-09</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 -<span style="color: #BB0000;">83.2</span>  42.1 2022-01-22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>    11 -<span style="color: #BB0000;">83.3</span>  42.2 2022-04-02</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    12 -<span style="color: #BB0000;">83.3</span>  42.2 2022-10-18</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>    13 -<span style="color: #BB0000;">83.4</span>  42.3 2022-06-02</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    14 -<span style="color: #BB0000;">83.4</span>  42.2 2022-11-25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>    15 -<span style="color: #BB0000;">83.4</span>  42.1 2022-06-18</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>    16 -<span style="color: #BB0000;">83.3</span>  42.4 2022-05-27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>    17 -<span style="color: #BB0000;">83.2</span>  42.3 2022-03-09</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    18 -<span style="color: #BB0000;">83.1</span>  42.3 2022-11-06</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span>    19 -<span style="color: #BB0000;">83.4</span>  42.1 2022-02-28</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span>    20 -<span style="color: #BB0000;">83.4</span>  42.4 2022-04-08</span></span></code></pre></div>
<p>For this example, we want to estimate the fine particulate matter on
the days of the case, as well as control dates. Here, we define these
control dates using time stratification on year, month, and day-of-week,
and use the <code>purrr</code> package to create a list-col of dates for
each location in our example data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">case_date</span><span class="op">)</span> <span class="op">-</span> <span class="fl">31</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">case_date</span><span class="op">)</span> <span class="op">+</span> <span class="fl">31</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">make_control_dates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">case_date</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dates_seq</span><span class="op">[</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">dates_seq</span><span class="op">)</span> <span class="op">==</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">case_date</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>              <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">dates_seq</span><span class="op">)</span> <span class="op">==</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html" class="external-link">month</a></span><span class="op">(</span><span class="va">case_date</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>              <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">wday</a></span><span class="op">(</span><span class="va">dates_seq</span><span class="op">)</span> <span class="op">==</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">wday</a></span><span class="op">(</span><span class="va">case_date</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>              <span class="va">dates_seq</span> <span class="op">!=</span> <span class="va">case_date</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dates <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">case_date</span>, <span class="va">make_control_dates</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 Ã— 5</span></span></span>
<span><span class="co">#&gt;       id   lon   lat case_date  dates     </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 -<span style="color: #BB0000;">83.4</span>  42.3 2022-03-04 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 -<span style="color: #BB0000;">83.2</span>  42.3 2022-12-08 <span style="color: #949494;">&lt;date [4]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 -<span style="color: #BB0000;">83.1</span>  42.4 2022-11-16 <span style="color: #949494;">&lt;date [4]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 -<span style="color: #BB0000;">83.5</span>  42.4 2022-11-21 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 -<span style="color: #BB0000;">83.3</span>  42.3 2022-03-30 <span style="color: #949494;">&lt;date [4]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 -<span style="color: #BB0000;">83.4</span>  42.2 2022-09-25 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 -<span style="color: #BB0000;">83.5</span>  42.3 2022-11-10 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 -<span style="color: #BB0000;">83.2</span>  42.2 2022-05-21 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 -<span style="color: #BB0000;">83.5</span>  42.2 2022-02-09 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 -<span style="color: #BB0000;">83.2</span>  42.1 2022-01-22 <span style="color: #949494;">&lt;date [4]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>    11 -<span style="color: #BB0000;">83.3</span>  42.2 2022-04-02 <span style="color: #949494;">&lt;date [4]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    12 -<span style="color: #BB0000;">83.3</span>  42.2 2022-10-18 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>    13 -<span style="color: #BB0000;">83.4</span>  42.3 2022-06-02 <span style="color: #949494;">&lt;date [4]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    14 -<span style="color: #BB0000;">83.4</span>  42.2 2022-11-25 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>    15 -<span style="color: #BB0000;">83.4</span>  42.1 2022-06-18 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>    16 -<span style="color: #BB0000;">83.3</span>  42.4 2022-05-27 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>    17 -<span style="color: #BB0000;">83.2</span>  42.3 2022-03-09 <span style="color: #949494;">&lt;date [4]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    18 -<span style="color: #BB0000;">83.1</span>  42.3 2022-11-06 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span>    19 -<span style="color: #BB0000;">83.4</span>  42.1 2022-02-28 <span style="color: #949494;">&lt;date [3]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span>    20 -<span style="color: #BB0000;">83.4</span>  42.4 2022-04-08 <span style="color: #949494;">&lt;date [4]&gt;</span></span></span></code></pre></div>
<p>Next, we will use the <code>lon</code> and <code>lat</code> columns
to create the s2 geohash:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>s2 <span class="op">=</span> <span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_cell.html" class="external-link">as_s2_cell</a></span><span class="op">(</span><span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_geog_point.html" class="external-link">s2_geog_point</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 Ã— 6</span></span></span>
<span><span class="co">#&gt;       id   lon   lat case_date  dates      s2              </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;s2cell&gt;</span>        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 -<span style="color: #BB0000;">83.4</span>  42.3 2022-03-04 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b4e78fa19c791</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 -<span style="color: #BB0000;">83.2</span>  42.3 2022-12-08 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b35cc4ba66441</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 -<span style="color: #BB0000;">83.1</span>  42.4 2022-11-16 <span style="color: #949494;">&lt;date [4]&gt;</span> 8824d1c4221a404d</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 -<span style="color: #BB0000;">83.5</span>  42.4 2022-11-21 <span style="color: #949494;">&lt;date [3]&gt;</span> 8824ac91034223fd</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 -<span style="color: #BB0000;">83.3</span>  42.3 2022-03-30 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b4b883eaee6a9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 -<span style="color: #BB0000;">83.4</span>  42.2 2022-09-25 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b5a98d6916351</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 -<span style="color: #BB0000;">83.5</span>  42.3 2022-11-10 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b53d53bf1afdb</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 -<span style="color: #BB0000;">83.2</span>  42.2 2022-05-21 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b382f5e635e85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 -<span style="color: #BB0000;">83.5</span>  42.2 2022-02-09 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b5085aa2e463f</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 -<span style="color: #BB0000;">83.2</span>  42.1 2022-01-22 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b3f0a2e63178b</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>    11 -<span style="color: #BB0000;">83.3</span>  42.2 2022-04-02 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b45c571cc86e1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    12 -<span style="color: #BB0000;">83.3</span>  42.2 2022-10-18 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b486d990c8343</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>    13 -<span style="color: #BB0000;">83.4</span>  42.3 2022-06-02 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b4e77b735c45d</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    14 -<span style="color: #BB0000;">83.4</span>  42.2 2022-11-25 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b4f9c941cef3f</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>    15 -<span style="color: #BB0000;">83.4</span>  42.1 2022-06-18 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b437250debe45</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>    16 -<span style="color: #BB0000;">83.3</span>  42.4 2022-05-27 <span style="color: #949494;">&lt;date [3]&gt;</span> 8824b57443b3bf27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>    17 -<span style="color: #BB0000;">83.2</span>  42.3 2022-03-09 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b35cab32bc153</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    18 -<span style="color: #BB0000;">83.1</span>  42.3 2022-11-06 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b33043a70f3f3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span>    19 -<span style="color: #BB0000;">83.4</span>  42.1 2022-02-28 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b43ea5b08bcfb</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span>    20 -<span style="color: #BB0000;">83.4</span>  42.4 2022-04-08 <span style="color: #949494;">&lt;date [4]&gt;</span> 8824b30daf72d54b</span></span></code></pre></div>
<p>Then we can directly use the <code>s2</code> and <code>dates</code>
columns to add temperature and humidity using the
<code><a href="../reference/get_narr_data.html">get_narr_data()</a></code> function and PM2.5 using the
<code><a href="../reference/predict_pm25.html">predict_pm25()</a></code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>temperature <span class="op">=</span> <span class="fu"><a href="../reference/get_narr_data.html">get_narr_data</a></span><span class="op">(</span><span class="va">s2</span>, <span class="va">dates</span>, <span class="st">"air.2m"</span><span class="op">)</span>, </span>
<span>                        humidity <span class="op">=</span> <span class="fu"><a href="../reference/get_narr_data.html">get_narr_data</a></span><span class="op">(</span><span class="va">s2</span>, <span class="va">dates</span>, <span class="st">"rhum.2m"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; downloading 2022 air.2m:</span></span>
<span><span class="co">#&gt; downloading 2022 rhum.2m:</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pm25 <span class="op">=</span> <span class="fu"><a href="../reference/predict_pm25.html">predict_pm25</a></span><span class="op">(</span><span class="va">s2</span>, <span class="va">dates</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">â„¹</span> (down)loading random forest model</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">âœ”</span> (down)loading random forest model <span style="color: #B2B2B2;">[15.7s]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">â„¹</span> checking that s2 locations are within the contiguous united states</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">âœ”</span> checking that s2 locations are within the contiguous united states <span style="color: #B2B2B2;">[109ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">â„¹</span> adding coordinates</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">âœ”</span> adding coordinates <span style="color: #B2B2B2;">[78ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">â„¹</span> adding elevation</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">âœ”</span> adding elevation <span style="color: #B2B2B2;">[693ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">â„¹</span> adding HMS smoke data</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">âœ”</span> adding HMS smoke data <span style="color: #B2B2B2;">[1.8s]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">â„¹</span> adding NARR</span></span>
<span><span class="co">#&gt; downloading 2022 hpbl:</span></span>
<span><span class="co">#&gt; downloading 2022 acpcp:</span></span>
<span><span class="co">#&gt; downloading 2022 vis:</span></span>
<span><span class="co">#&gt; downloading 2022 pres.sfc:</span></span>
<span><span class="co">#&gt; downloading 2022 uwnd.10m:</span></span>
<span><span class="co">#&gt; downloading 2022 vwnd.10m:</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">âœ”</span> adding NARR <span style="color: #B2B2B2;">[13.9s]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">â„¹</span> adding MERRA</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">âœ”</span> adding MERRA <span style="color: #B2B2B2;">[1.9s]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">â„¹</span> adding time components</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">âœ”</span> adding time components <span style="color: #B2B2B2;">[39ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span></span>
<span><span class="va">d</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 Ã— 9</span></span></span>
<span><span class="co">#&gt;       id   lon   lat case_date  dates      s2      temperature humidity pm25    </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;s2cel&gt;</span> <span style="color: #949494; font-style: italic;">&lt;named lis&gt;</span> <span style="color: #949494; font-style: italic;">&lt;named &gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 -<span style="color: #BB0000;">83.4</span>  42.3 2022-03-04 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b4eâ€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 -<span style="color: #BB0000;">83.2</span>  42.3 2022-12-08 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b35â€¦ <span style="color: #949494;">&lt;dbl [4]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 -<span style="color: #BB0000;">83.1</span>  42.4 2022-11-16 <span style="color: #949494;">&lt;date [4]&gt;</span> 8824d1â€¦ <span style="color: #949494;">&lt;dbl [4]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 -<span style="color: #BB0000;">83.5</span>  42.4 2022-11-21 <span style="color: #949494;">&lt;date [3]&gt;</span> 8824acâ€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 -<span style="color: #BB0000;">83.3</span>  42.3 2022-03-30 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b4bâ€¦ <span style="color: #949494;">&lt;dbl [4]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 -<span style="color: #BB0000;">83.4</span>  42.2 2022-09-25 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b5aâ€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 -<span style="color: #BB0000;">83.5</span>  42.3 2022-11-10 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b53â€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 -<span style="color: #BB0000;">83.2</span>  42.2 2022-05-21 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b38â€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 -<span style="color: #BB0000;">83.5</span>  42.2 2022-02-09 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b50â€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 -<span style="color: #BB0000;">83.2</span>  42.1 2022-01-22 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b3fâ€¦ <span style="color: #949494;">&lt;dbl [4]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>    11 -<span style="color: #BB0000;">83.3</span>  42.2 2022-04-02 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b45â€¦ <span style="color: #949494;">&lt;dbl [4]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    12 -<span style="color: #BB0000;">83.3</span>  42.2 2022-10-18 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b48â€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>    13 -<span style="color: #BB0000;">83.4</span>  42.3 2022-06-02 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b4eâ€¦ <span style="color: #949494;">&lt;dbl [4]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    14 -<span style="color: #BB0000;">83.4</span>  42.2 2022-11-25 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b4fâ€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>    15 -<span style="color: #BB0000;">83.4</span>  42.1 2022-06-18 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b43â€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>    16 -<span style="color: #BB0000;">83.3</span>  42.4 2022-05-27 <span style="color: #949494;">&lt;date [3]&gt;</span> 8824b5â€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>    17 -<span style="color: #BB0000;">83.2</span>  42.3 2022-03-09 <span style="color: #949494;">&lt;date [4]&gt;</span> 883b35â€¦ <span style="color: #949494;">&lt;dbl [4]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    18 -<span style="color: #BB0000;">83.1</span>  42.3 2022-11-06 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b33â€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span>    19 -<span style="color: #BB0000;">83.4</span>  42.1 2022-02-28 <span style="color: #949494;">&lt;date [3]&gt;</span> 883b43â€¦ <span style="color: #949494;">&lt;dbl [3]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span>    20 -<span style="color: #BB0000;">83.4</span>  42.4 2022-04-08 <span style="color: #949494;">&lt;date [4]&gt;</span> 8824b3â€¦ <span style="color: #949494;">&lt;dbl [4]&gt;</span>   <span style="color: #949494;">&lt;dbl&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span></span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Cole Brokamp, Erika Manning, Qing Duan.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
