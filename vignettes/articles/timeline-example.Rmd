---
title: "Timeline Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Timeline Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(appc)
library(dplyr, warn.conflicts = FALSE)
```

This example details how to use the appc package to add air pollution exposure estimates for exact locations and time periods defined by geocoded coordinates and a "key" date. For this example workflow, we will simulate 20 random locations in Wayne County, Michigan and dates of birth during 2022, but in actuality this can be any set of geocoded `lat` and `lon` columns with corresponding dates.

```{r}
#| warnings: false
#| messages: false
d <-
  tigris::counties("MI", year = 2021, progress_bar = FALSE) |>
  suppressWarnings() |>
  filter(GEOID == 26163) |>
  sf::st_sample(20) |>
  sf::st_coordinates() |>
  tibble::as_tibble() |>
  rename(lat = Y, lon = X) |>
  mutate(dob = sample(seq(as.Date("2023-01-01"), as.Date("2023-12-31"), by = 1), size = 20))

d
```

For this example, we want to estimate the average fine particulate matter from 90 days prior to birth until the date of birth. Using the dob column as the start date, we will define an end date in our example data and also define the s2 cell identifers based on the latitude and longitude coordinates.

```{r}
d <- d |>
	mutate(d, dob_plus_90 = dob + 90,
	       s2 = s2::as_s2_cell(s2::s2_geog_point(lon, lat)))

head(d)
```

Next, use the newly created columns to call the `predict_pm25_date_range()` function, which is a simpler implementation of predict_pm25 that takes vectors of start and end dates instead of lists of date vectors for each s2 cell location:

```{r}
dplyr::mutate(d, pm25 = predict_pm25_date_range(s2, dob, dob_plus_90))
```

If interested in average exposures (and their uncertainties) from start date to end date (instead of daily exposures), we can extract those directly:

```{r}
d_pm25 <- with(d, predict_pm25_date_range(s2, dob, dob_plus_90, average = TRUE))
bind_cols(d, bind_rows(d_pm25))
```
